% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/batch-correction.R
\name{step_measure_batch_reference}
\alias{step_measure_batch_reference}
\title{Reference-Based Batch Correction}
\usage{
step_measure_batch_reference(
  recipe,
  ...,
  batch_col = "batch_id",
  sample_type_col = "sample_type",
  reference_type = "reference",
  method = c("median_ratio", "mean_ratio", "median_center", "mean_center"),
  target_batch = NULL,
  min_ref = 2,
  role = NA,
  trained = FALSE,
  skip = FALSE,
  id = recipes::rand_id("measure_batch_reference")
)
}
\arguments{
\item{recipe}{A recipe object.}

\item{...}{One or more selector functions to choose feature columns.}

\item{batch_col}{Name of the column containing batch identifiers.}

\item{sample_type_col}{Name of the column containing sample type.}

\item{reference_type}{Value(s) in \code{sample_type_col} that identify reference
samples to use for batch correction. Default is \code{"reference"}.}

\item{method}{Correction method:
\itemize{
\item \code{"median_ratio"} (default): Scale by ratio of reference medians
\item \code{"mean_ratio"}: Scale by ratio of reference means
\item \code{"median_center"}: Center batches to common median
\item \code{"mean_center"}: Center batches to common mean
}}

\item{target_batch}{Which batch to use as reference. Default is the first
batch (alphabetically). Can also be \code{"global"} to use global reference
median/mean.}

\item{min_ref}{Minimum number of reference samples per batch. Default is 2.}

\item{role}{Not used by this step.}

\item{trained}{Logical indicating if the step has been trained.}

\item{skip}{Logical. Should the step be skipped when baking?}

\item{id}{Unique step identifier.}
}
\value{
An updated recipe with the new step added.
}
\description{
\code{step_measure_batch_reference()} creates a \emph{specification} of a recipe step
that corrects for batch effects using reference samples. This is a simpler
alternative to ComBat-style correction that doesn't require heavy dependencies.
}
\details{
\subsection{Correction Methods}{

\strong{Median/Mean Ratio}: Multiplies all samples in a batch by:
\code{target_reference / batch_reference}

This preserves relative differences within batches while aligning
batch centers.

\strong{Median/Mean Center}: Subtracts the difference between batch reference
and target reference. This is appropriate for log-transformed data.
}

\subsection{Reference Samples}{

Reference samples should be identical samples run in each batch
(e.g., pooled QC, reference material). The step will error if any
batch lacks sufficient reference samples.
}
}
\examples{
library(recipes)

# Data with batch effects
data <- data.frame(
  sample_id = paste0("S", 1:20),
  sample_type = rep(c("reference", "unknown", "unknown", "unknown", "reference"), 4),
  batch_id = rep(c("B1", "B1", "B2", "B2"), 5),
  feature1 = c(rep(100, 10), rep(120, 10)) + rnorm(20, sd = 5),  # Batch effect
  feature2 = c(rep(50, 10), rep(45, 10)) + rnorm(20, sd = 2)
)

rec <- recipe(~ ., data = data) |>
  update_role(sample_id, new_role = "id") |>
  step_measure_batch_reference(feature1, feature2, batch_col = "batch_id") |>
  prep()

corrected <- bake(rec, new_data = NULL)
}
\seealso{
\code{\link[=step_measure_drift_qc_loess]{step_measure_drift_qc_loess()}} for within-batch drift correction.
}
\concept{batch-correction}
