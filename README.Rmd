---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# measure

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
[![R-CMD-check](https://github.com/JamesHWade/measure/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/JamesHWade/measure/actions/workflows/R-CMD-check.yaml)
[![Codecov test coverage](https://codecov.io/gh/JamesHWade/measure/branch/main/graph/badge.svg)](https://app.codecov.io/gh/JamesHWade/measure?branch=main)
<!-- badges: end -->

## Overview

measure extends [tidymodels](https://www.tidymodels.org/) with preprocessing steps for analytical measurement data such as spectroscopy, chromatography, and other instrument-generated signals. It provides a [recipes](https://recipes.tidymodels.org/)-style interface for common spectral preprocessing techniques.

measure helps you:

- **Convert** measurement data from wide or long formats into an internal representation
- **Preprocess** spectra using techniques like smoothing, derivatives, and normalization
- **Transform** data back to wide or long format for modeling or visualization

## Installation
You can install the development version of measure from [GitHub](https://github.com/):

```r
# install.packages("pak")
pak::pak("JamesHWade/measure")
```

## Usage

The measure workflow follows the familiar recipes pattern: define a recipe, add steps, prep, and bake.

```{r example, message = FALSE}
library(measure)
library(recipes)
library(ggplot2)

# NIR spectroscopy data for predicting meat composition
data(meats_long)
head(meats_long)
```
### Building a preprocessing recipe

```{r recipe}
rec <- recipe(water + fat + protein ~ ., data = meats_long) |>
  # Assign sample ID role (not used as predictor)
  update_role(id, new_role = "id") |>
  # Convert long-format measurements to internal representation
  step_measure_input_long(transmittance, location = vars(channel)) |>
  # Apply Savitzky-Golay smoothing with first derivative
  step_measure_savitzky_golay(window_side = 5, differentiation_order = 1) |>
  # Standard Normal Variate normalization
  step_measure_snv() |>
  # Convert back to wide format for modeling
  step_measure_output_wide(prefix = "nir_")
```

### Preparing and applying the recipe

```{r prep-bake}
# Prep learns any parameters from training data
prepped <- prep(rec)

# Bake applies the transformations
processed <- bake(prepped, new_data = NULL)

# Result is ready for modeling
processed[1:5, 1:8]
```

### Visualizing the preprocessing

```{r visualization, fig.width = 8, fig.height = 4}
# Get data at intermediate step (before output conversion)
rec_for_viz <- recipe(water + fat + protein ~ ., data = meats_long) |>
update_role(id, new_role = "id") |>
  step_measure_input_long(transmittance, location = vars(channel)) |>
  step_measure_savitzky_golay(window_side = 5, differentiation_order = 1) |>
  step_measure_snv()

processed_long <- bake(prep(rec_for_viz), new_data = NULL)

# Extract and plot a few spectra
library(tidyr)
library(dplyr)

plot_data <- processed_long |>
  slice(1:10) |>
  mutate(sample_id = row_number()) |>
  unnest(.measures)

ggplot(plot_data, aes(x = location, y = value, group = sample_id, color = factor(sample_id))) +
  geom_line(alpha = 0.7) +
  labs(
    x = "Channel",
    y = "Preprocessed Signal",
    title = "NIR Spectra After Preprocessing",
    subtitle = "Savitzky-Golay first derivative + SNV normalization",
    color = "Sample"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

## Available Steps

### Input Steps
Convert your data to measure's internal format:

| Step | Description |
|------|-------------|
| `step_measure_input_wide()` | For data with measurements in columns (e.g., wavelengths as column names) |
| `step_measure_input_long()` | For data with measurements in rows (long format) |

### Processing Steps
Apply spectral preprocessing:

| Step | Description |
|------|-------------|
| `step_measure_savitzky_golay()` | Smoothing and/or differentiation using Savitzky-Golay filter |
| `step_measure_snv()` | Standard Normal Variate normalization |
| `step_measure_msc()` | Multiplicative Scatter Correction |

### Output Steps
Convert back to modeling-ready format:

| Step | Description |
|------|-------------|
| `step_measure_output_wide()` | Convert to wide format (one column per measurement point) |
| `step_measure_output_long()` | Convert to long format |

## Learning more

- [Getting Started](https://jameshwade.github.io/measure/articles/measure.html) - A comprehensive introduction to measure
- [Preprocessing Techniques](https://jameshwade.github.io/measure/articles/preprocessing.html) - Deep dive into available preprocessing methods

## Related packages

measure builds on the [tidymodels](https://www.tidymodels.org/) ecosystem:

- [recipes](https://recipes.tidymodels.org/) - The foundation for preprocessing pipelines
- [parsnip](https://parsnip.tidymodels.org/) - Unified modeling interface
- [workflows](https://workflows.tidymodels.org/) - Bundle preprocessing and modeling
- [tune](https://tune.tidymodels.org/) - Hyperparameter tuning (works with measure's tunable steps!)

For spectral analysis in R, you might also find these packages useful:

- [prospectr](https://github.com/l-ramirez-lopez/prospectr) - Spectral preprocessing functions
- [ChemoSpec](https://bryanhanson.github.io/ChemoSpec/) - Exploratory chemometrics
- [mdatools](https://mdatools.com/) - Multivariate data analysis

## Contributing

This package is under active development. Contributions are welcome! Please see the [contributing guidelines](https://jameshwade.github.io/measure/CONTRIBUTING.html).

## Code of Conduct

Please note that the measure project is released with a [Contributor Code of Conduct](https://jameshwade.github.io/measure/CODE_OF_CONDUCT.html). By contributing to this project, you agree to abide by its terms.
