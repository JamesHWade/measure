<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Preprocessing Techniques • measure</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Preprocessing Techniques">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">measure</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.0.1.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/measure.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/measure.html">Getting Started</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Guides</h6></li>
    <li><a class="dropdown-item" href="../articles/preprocessing.html">Preprocessing Techniques</a></li>
    <li><a class="dropdown-item" href="../articles/recipes.html">Integrating with tidymodels</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Examples</h6></li>
    <li><a class="dropdown-item" href="../articles/baseline.html">Baseline Correction</a></li>
    <li><a class="dropdown-item" href="../articles/sec-analysis-example.html">Bioreactor Case Study</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Developer</h6></li>
    <li><a class="dropdown-item" href="../articles/internals.html">Internal Class System</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/JamesHWade/measure/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Preprocessing Techniques</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/JamesHWade/measure/blob/main/vignettes/preprocessing.Rmd" class="external-link"><code>vignettes/preprocessing.Rmd</code></a></small>
      <div class="d-none name"><code>preprocessing.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jameshwade.github.io/measure/">measure</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/recipes" class="external-link">recipes</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://modeldata.tidymodels.org" class="external-link">modeldata</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Helper function to process and plot spectra</span></span>
<span><span class="va">plot_spectra</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">title</span>, <span class="va">subtitle</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">location</span>, y <span class="op">=</span> <span class="va">value</span>, group <span class="op">=</span> <span class="va">sample_id</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">sample_id</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.7</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Wavelength"</span>, y <span class="op">=</span> <span class="st">"Signal"</span>, title <span class="op">=</span> <span class="va">title</span>, subtitle <span class="op">=</span> <span class="va">subtitle</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Prepare sample data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">meats</span><span class="op">)</span></span>
<span><span class="va">wavelengths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">850</span>, <span class="fl">1050</span>, length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get spectra in internal format for demonstrations</span></span>
<span><span class="va">get_internal</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">rec</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html" class="external-link">bake</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep</a></span><span class="op">(</span><span class="va">rec</span><span class="op">)</span>, new_data <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">15</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sample_id <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">.measures</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Spectral preprocessing is essential for building accurate chemometric
models. Raw spectra often contain unwanted variation from physical
effects (scatter, baseline drift) that obscure the chemical information
we’re trying to model. This vignette covers each preprocessing technique
available in measure and when to use them.</p>
</div>
<div class="section level2">
<h2 id="why-preprocess-spectra">Why preprocess spectra?<a class="anchor" aria-label="anchor" href="#why-preprocess-spectra"></a>
</h2>
<p>Before diving into specific techniques, let’s understand what we’re
dealing with. Here are raw NIR spectra from the meats dataset:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span></span>
<span></span>
<span><span class="va">raw_data</span> <span class="op">&lt;-</span> <span class="fu">get_internal</span><span class="op">(</span><span class="va">rec_raw</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plot_spectra</span><span class="op">(</span><span class="va">raw_data</span>, <span class="st">"Raw NIR Spectra"</span>, <span class="st">"Note the vertical offset differences between samples"</span><span class="op">)</span></span></code></pre></div>
<p><img src="preprocessing_files/figure-html/raw-spectra-1.png" class="r-plt" alt="" width="672"></p>
<p>Notice how spectra are shifted vertically relative to each other?
This offset isn’t due to chemical differences - it’s caused by physical
factors like particle size, path length, and light scatter. Our
preprocessing goal is to remove these unwanted effects while preserving
the chemical information.</p>
</div>
<div class="section level2">
<h2 id="savitzky-golay-filtering">Savitzky-Golay Filtering<a class="anchor" aria-label="anchor" href="#savitzky-golay-filtering"></a>
</h2>
<div class="section level3">
<h3 id="what-it-does">What it does<a class="anchor" aria-label="anchor" href="#what-it-does"></a>
</h3>
<p>The Savitzky-Golay filter performs polynomial smoothing and can
compute derivatives. It fits a polynomial to a sliding window of points,
using the polynomial’s value (or derivative) at the center point as the
output.</p>
</div>
<div class="section level3">
<h3 id="when-to-use-it">When to use it<a class="anchor" aria-label="anchor" href="#when-to-use-it"></a>
</h3>
<ul>
<li>
<strong>Smoothing (order = 0)</strong>: Reduce random noise while
preserving peak shapes</li>
<li>
<strong>First derivative (order = 1)</strong>: Remove constant
baseline offsets, enhance peak differences</li>
<li>
<strong>Second derivative (order = 2)</strong>: Remove linear
baseline trends, further enhance peak resolution</li>
</ul>
</div>
<div class="section level3">
<h3 id="parameters">Parameters<a class="anchor" aria-label="anchor" href="#parameters"></a>
</h3>
<ul>
<li>
<code>window_side</code>: Number of points on each side of the
center point (total window = 2 * window_side + 1)</li>
<li>
<code>differentiation_order</code>: 0 for smoothing, 1 for first
derivative, 2 for second derivative</li>
<li>
<code>degree</code>: Polynomial degree (defaults to
differentiation_order + 1)</li>
</ul>
</div>
<div class="section level3">
<h3 id="examples">Examples<a class="anchor" aria-label="anchor" href="#examples"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Just smoothing</span></span>
<span><span class="va">rec_smooth</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_savitzky_golay.html">step_measure_savitzky_golay</a></span><span class="op">(</span>window_side <span class="op">=</span> <span class="fl">7</span>, differentiation_order <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># First derivative</span></span>
<span><span class="va">rec_d1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_savitzky_golay.html">step_measure_savitzky_golay</a></span><span class="op">(</span>window_side <span class="op">=</span> <span class="fl">5</span>, differentiation_order <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Second derivative</span></span>
<span><span class="va">rec_d2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_savitzky_golay.html">step_measure_savitzky_golay</a></span><span class="op">(</span>window_side <span class="op">=</span> <span class="fl">7</span>, differentiation_order <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">plot_spectra</span><span class="op">(</span><span class="va">raw_data</span>, <span class="st">"Raw"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">plot_spectra</span><span class="op">(</span><span class="fu">get_internal</span><span class="op">(</span><span class="va">rec_smooth</span><span class="op">)</span>, <span class="st">"Smoothed (window = 15)"</span><span class="op">)</span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu">plot_spectra</span><span class="op">(</span><span class="fu">get_internal</span><span class="op">(</span><span class="va">rec_d1</span><span class="op">)</span>, <span class="st">"1st Derivative"</span>, <span class="st">"Baseline offset removed"</span><span class="op">)</span></span>
<span><span class="va">p4</span> <span class="op">&lt;-</span> <span class="fu">plot_spectra</span><span class="op">(</span><span class="fu">get_internal</span><span class="op">(</span><span class="va">rec_d2</span><span class="op">)</span>, <span class="st">"2nd Derivative"</span>, <span class="st">"Linear baseline removed"</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">p3</span> <span class="op">+</span> <span class="va">p4</span><span class="op">)</span></span></code></pre></div>
<p><img src="preprocessing_files/figure-html/sg-plots-1.png" class="r-plt" alt="" width="672"></p>
</div>
<div class="section level3">
<h3 id="choosing-window-size">Choosing window size<a class="anchor" aria-label="anchor" href="#choosing-window-size"></a>
</h3>
<p>The window size is a bias-variance trade-off: - <strong>Smaller
window</strong>: Less smoothing, preserves sharp features, more noise -
<strong>Larger window</strong>: More smoothing, may blur sharp peaks,
less noise</p>
<p>A good starting point is a window that spans the narrowest feature
you want to preserve.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">windows</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">7</span>, <span class="fl">15</span><span class="op">)</span></span>
<span></span>
<span><span class="va">window_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">windows</span>, <span class="kw">function</span><span class="op">(</span><span class="va">w</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/step_measure_savitzky_golay.html">step_measure_savitzky_golay</a></span><span class="op">(</span>window_side <span class="op">=</span> <span class="va">w</span>, differentiation_order <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">get_internal</span><span class="op">(</span><span class="va">rec</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sample_id</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>window <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"window_side = "</span>, <span class="va">w</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">window_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">location</span>, y <span class="op">=</span> <span class="va">value</span>, color <span class="op">=</span> <span class="va">window</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Wavelength"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Signal"</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Effect of Window Size on First Derivative"</span>,</span>
<span>    color <span class="op">=</span> <span class="cn">NULL</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="preprocessing_files/figure-html/window-comparison-1.png" class="r-plt" alt="" width="672"></p>
</div>
<div class="section level3">
<h3 id="tuning-with-dials">Tuning with dials<a class="anchor" aria-label="anchor" href="#tuning-with-dials"></a>
</h3>
<p>The Savitzky-Golay step is tunable! This means you can use
<code><a href="https://hardhat.tidymodels.org/reference/tune.html" class="external-link">tune()</a></code> to find optimal parameters:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tune.tidymodels.org/" class="external-link">tune</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/workflows" class="external-link">workflows</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">rec_tunable</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_savitzky_golay.html">step_measure_savitzky_golay</a></span><span class="op">(</span></span>
<span>    window_side <span class="op">=</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/tune.html" class="external-link">tune</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    differentiation_order <span class="op">=</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/tune.html" class="external-link">tune</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_output_wide.html">step_measure_output_wide</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The tunable parameters are:</span></span>
<span><span class="fu"><a href="https://generics.r-lib.org/reference/tunable.html" class="external-link">tunable</a></span><span class="op">(</span><span class="va">rec_tunable</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="spectral-math-transformations">Spectral Math Transformations<a class="anchor" aria-label="anchor" href="#spectral-math-transformations"></a>
</h2>
<p>The measure package includes mathematical transformations commonly
used in spectroscopy and chemometrics.</p>
<div class="section level3">
<h3 id="absorbance-and-transmittance">Absorbance and Transmittance<a class="anchor" aria-label="anchor" href="#absorbance-and-transmittance"></a>
</h3>
<p>Convert between transmittance and absorbance using the Beer-Lambert
relationship:</p>
<ul>
<li>
<strong>Absorbance</strong>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>=</mo><mo>−</mo><msub><mo>log</mo><mn>10</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>T</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">A = -\log_{10}(T)</annotation></semantics></math>
</li>
<li>
<strong>Transmittance</strong>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mo>=</mo><msup><mn>10</mn><mrow><mo>−</mo><mi>A</mi></mrow></msup></mrow><annotation encoding="application/x-tex">T = 10^{-A}</annotation></semantics></math>
</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Convert transmittance to absorbance</span></span>
<span><span class="va">rec_abs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_absorbance.html">step_measure_absorbance</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plot_spectra</span><span class="op">(</span><span class="fu">get_internal</span><span class="op">(</span><span class="va">rec_abs</span><span class="op">)</span>, <span class="st">"Absorbance"</span>, <span class="st">"Converted from transmittance"</span><span class="op">)</span></span></code></pre></div>
<p><img src="preprocessing_files/figure-html/absorbance-example-1.png" class="r-plt" alt="" width="672"></p>
<p>These transformations are inverses - a round-trip preserves
values:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec_roundtrip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_absorbance.html">step_measure_absorbance</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_transmittance.html">step_measure_transmittance</a></span><span class="op">(</span><span class="op">)</span>  <span class="co"># Back to original</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="log-transformation">Log Transformation<a class="anchor" aria-label="anchor" href="#log-transformation"></a>
</h3>
<p>Apply logarithmic transformation with configurable base and
offset:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Natural log (base e)</span></span>
<span><span class="va">rec_log</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_log.html">step_measure_log</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Log base 10 with offset for handling zeros</span></span>
<span><span class="va">rec_log10</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_log.html">step_measure_log</a></span><span class="op">(</span>base <span class="op">=</span> <span class="fl">10</span>, offset <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plot_spectra</span><span class="op">(</span><span class="fu">get_internal</span><span class="op">(</span><span class="va">rec_log</span><span class="op">)</span>, <span class="st">"Natural Log Transform"</span><span class="op">)</span></span></code></pre></div>
<p><img src="preprocessing_files/figure-html/log-example-1.png" class="r-plt" alt="" width="672"></p>
</div>
<div class="section level3">
<h3 id="kubelka-munk-transformation">Kubelka-Munk Transformation<a class="anchor" aria-label="anchor" href="#kubelka-munk-transformation"></a>
</h3>
<p>For diffuse reflectance data, the Kubelka-Munk transformation
converts reflectance to a quantity proportional to concentration:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>R</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mi>R</mi><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup><mrow><mn>2</mn><mi>R</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">f(R) = \frac{(1-R)^2}{2R}</annotation></semantics></math></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># For reflectance data (values between 0 and 1)</span></span>
<span><span class="va">rec_km</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">concentration</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">reflectance_data</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"r_"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_kubelka_munk.html">step_measure_kubelka_munk</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="simple-finite-difference-derivatives">Simple Finite Difference Derivatives<a class="anchor" aria-label="anchor" href="#simple-finite-difference-derivatives"></a>
</h3>
<p>For quick derivatives without smoothing, use
<code><a href="../reference/step_measure_derivative.html">step_measure_derivative()</a></code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># First derivative - removes constant baseline offsets</span></span>
<span><span class="va">rec_fd1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_derivative.html">step_measure_derivative</a></span><span class="op">(</span>order <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Second derivative - removes linear baseline trends</span></span>
<span><span class="va">rec_fd2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_derivative.html">step_measure_derivative</a></span><span class="op">(</span>order <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><strong>Note</strong>: Derivatives reduce spectrum length (first
derivative: n-1 points, second derivative: n-2 points). The
<code>order</code> parameter is tunable.</p>
</div>
<div class="section level3">
<h3 id="gap-norris-williams-derivatives">Gap (Norris-Williams) Derivatives<a class="anchor" aria-label="anchor" href="#gap-norris-williams-derivatives"></a>
</h3>
<p>Gap derivatives compute differences between points separated by a
gap, commonly used in NIR chemometrics:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Gap derivative with gap=5</span></span>
<span><span class="va">rec_gap</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_derivative_gap.html">step_measure_derivative_gap</a></span><span class="op">(</span>gap <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Norris-Williams with segment averaging for noise reduction</span></span>
<span><span class="va">rec_nw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_derivative_gap.html">step_measure_derivative_gap</a></span><span class="op">(</span>gap <span class="op">=</span> <span class="fl">5</span>, segment <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plot_spectra</span><span class="op">(</span><span class="fu">get_internal</span><span class="op">(</span><span class="va">rec_gap</span><span class="op">)</span>, <span class="st">"Gap Derivative (gap=5)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="preprocessing_files/figure-html/gap-derivative-1.png" class="r-plt" alt="" width="672"></p>
<p>Both <code>gap</code> and <code>segment</code> parameters are tunable
with dials.</p>
</div>
<div class="section level3">
<h3 id="when-to-use-each-derivative-method">When to use each derivative method<a class="anchor" aria-label="anchor" href="#when-to-use-each-derivative-method"></a>
</h3>
<table class="table">
<colgroup>
<col width="22%">
<col width="30%">
<col width="19%">
<col width="27%">
</colgroup>
<thead><tr class="header">
<th>Method</th>
<th>Smoothing</th>
<th>Speed</th>
<th>Use when</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code><a href="../reference/step_measure_savitzky_golay.html">step_measure_savitzky_golay()</a></code></td>
<td>Yes (polynomial)</td>
<td>Fast</td>
<td>Noisy data, need smoothing</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_derivative.html">step_measure_derivative()</a></code></td>
<td>No</td>
<td>Very fast</td>
<td>Clean data, unsmoothed derivative</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/step_measure_derivative_gap.html">step_measure_derivative_gap()</a></code></td>
<td>Optional (segment)</td>
<td>Fast</td>
<td>NIR chemometrics, configurable gap</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="region-operations">Region Operations<a class="anchor" aria-label="anchor" href="#region-operations"></a>
</h2>
<p>Region operations allow you to select, exclude, or resample specific
portions of your measurements. These are essential for chromatographic
workflows and useful for focusing analysis on regions of interest.</p>
<div class="section level3">
<h3 id="trimming-to-a-range">Trimming to a range<a class="anchor" aria-label="anchor" href="#trimming-to-a-range"></a>
</h3>
<p><code><a href="../reference/step_measure_trim.html">step_measure_trim()</a></code> keeps only measurements within a
specified x-axis range:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Keep only wavelengths 880-1020</span></span>
<span><span class="va">rec_trim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_trim.html">step_measure_trim</a></span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">880</span>, <span class="fl">1020</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">trim_data</span> <span class="op">&lt;-</span> <span class="fu">get_internal</span><span class="op">(</span><span class="va">rec_trim</span><span class="op">)</span></span>
<span><span class="fu">plot_spectra</span><span class="op">(</span><span class="va">trim_data</span>, <span class="st">"Trimmed to 880-1020 nm"</span>,</span>
<span>             <span class="st">"Removed noisy edge regions"</span><span class="op">)</span></span></code></pre></div>
<p><img src="preprocessing_files/figure-html/trim-example-1.png" class="r-plt" alt="" width="672"></p>
<p>Common use cases: - Remove noisy regions at measurement edges - Focus
on spectral region of interest - Define integration windows for
chromatography</p>
</div>
<div class="section level3">
<h3 id="excluding-ranges">Excluding ranges<a class="anchor" aria-label="anchor" href="#excluding-ranges"></a>
</h3>
<p><code><a href="../reference/step_measure_exclude.html">step_measure_exclude()</a></code> removes measurements within one
or more specified ranges:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Exclude water absorption bands</span></span>
<span><span class="va">rec_exclude</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_exclude.html">step_measure_exclude</a></span><span class="op">(</span>ranges <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">920</span>, <span class="fl">940</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">980</span>, <span class="fl">1000</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">exclude_data</span> <span class="op">&lt;-</span> <span class="fu">get_internal</span><span class="op">(</span><span class="va">rec_exclude</span><span class="op">)</span></span>
<span><span class="fu">plot_spectra</span><span class="op">(</span><span class="va">exclude_data</span>, <span class="st">"Excluded Regions"</span>,</span>
<span>             <span class="st">"Removed wavelength ranges 920-940 and 980-1000"</span><span class="op">)</span></span></code></pre></div>
<p><img src="preprocessing_files/figure-html/exclude-example-1.png" class="r-plt" alt="" width="672"></p>
<p>Common use cases: - Remove solvent peaks in chromatography - Exclude
detector saturation regions - Remove known interference regions</p>
</div>
<div class="section level3">
<h3 id="resampling-to-a-new-grid">Resampling to a new grid<a class="anchor" aria-label="anchor" href="#resampling-to-a-new-grid"></a>
</h3>
<p><code><a href="../reference/step_measure_resample.html">step_measure_resample()</a></code> interpolates measurements to a
new regular grid:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Resample to 50 evenly spaced points</span></span>
<span><span class="va">rec_resample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_resample.html">step_measure_resample</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span>, method <span class="op">=</span> <span class="st">"spline"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">resample_data</span> <span class="op">&lt;-</span> <span class="fu">get_internal</span><span class="op">(</span><span class="va">rec_resample</span><span class="op">)</span></span>
<span><span class="fu">plot_spectra</span><span class="op">(</span><span class="va">resample_data</span>, <span class="st">"Resampled to 50 Points"</span>,</span>
<span>             <span class="st">"Spline interpolation to regular grid"</span><span class="op">)</span></span></code></pre></div>
<p><img src="preprocessing_files/figure-html/resample-example-1.png" class="r-plt" alt="" width="672"></p>
<p>You can also specify the spacing between points:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Resample with 5 nm spacing</span></span>
<span><span class="va">rec_resample_spacing</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_resample.html">step_measure_resample</a></span><span class="op">(</span>spacing <span class="op">=</span> <span class="fl">5</span>, method <span class="op">=</span> <span class="st">"linear"</span><span class="op">)</span></span></code></pre></div>
<p>Common use cases: - Align data from different instruments with
different sampling rates - Reduce data density for faster processing -
Ensure uniform spacing for methods that require it</p>
</div>
<div class="section level3">
<h3 id="combining-region-operations">Combining region operations<a class="anchor" aria-label="anchor" href="#combining-region-operations"></a>
</h3>
<p>Region operations are often used together at the start of a
preprocessing pipeline:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec_regions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># First trim to region of interest</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_trim.html">step_measure_trim</a></span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">860</span>, <span class="fl">1040</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Then resample to regular grid</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_resample.html">step_measure_resample</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span>, method <span class="op">=</span> <span class="st">"spline"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Now apply spectral preprocessing</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_savitzky_golay.html">step_measure_savitzky_golay</a></span><span class="op">(</span>window_side <span class="op">=</span> <span class="fl">3</span>, differentiation_order <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_snv.html">step_measure_snv</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">region_pipeline_data</span> <span class="op">&lt;-</span> <span class="fu">get_internal</span><span class="op">(</span><span class="va">rec_regions</span><span class="op">)</span></span>
<span><span class="fu">plot_spectra</span><span class="op">(</span><span class="va">region_pipeline_data</span>, <span class="st">"Region Selection + Preprocessing"</span>,</span>
<span>             <span class="st">"Trim → Resample → SG derivative → SNV"</span><span class="op">)</span></span></code></pre></div>
<p><img src="preprocessing_files/figure-html/region-pipeline-1.png" class="r-plt" alt="" width="672"></p>
</div>
</div>
<div class="section level2">
<h2 id="baseline-correction">Baseline Correction<a class="anchor" aria-label="anchor" href="#baseline-correction"></a>
</h2>
<p>Baseline correction is critical for removing unwanted background
signals from spectral data. The measure package provides several
algorithms suited for different situations.</p>
<div class="section level3">
<h3 id="available-methods">Available methods<a class="anchor" aria-label="anchor" href="#available-methods"></a>
</h3>
<table style="width:100%;" class="table">
<colgroup>
<col width="22%">
<col width="40%">
<col width="37%">
</colgroup>
<thead><tr class="header">
<th>Step</th>
<th>Algorithm</th>
<th>Best for</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code><a href="../reference/step_measure_baseline_als.html">step_measure_baseline_als()</a></code></td>
<td>Asymmetric Least Squares</td>
<td>General purpose, smooth baselines</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_baseline_poly.html">step_measure_baseline_poly()</a></code></td>
<td>Polynomial fitting</td>
<td>Simple, predictable baselines</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/step_measure_baseline_rolling.html">step_measure_baseline_rolling()</a></code></td>
<td>Rolling ball</td>
<td>Wide peaks, chromatography</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_baseline_airpls.html">step_measure_baseline_airpls()</a></code></td>
<td>Adaptive Iteratively Reweighted PLS</td>
<td>Complex baselines</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/step_measure_baseline_snip.html">step_measure_baseline_snip()</a></code></td>
<td>SNIP algorithm</td>
<td>Spectroscopy with sharp peaks</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_detrend.html">step_measure_detrend()</a></code></td>
<td>Polynomial detrending</td>
<td>Linear/quadratic drift</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="rolling-ball-baseline">Rolling ball baseline<a class="anchor" aria-label="anchor" href="#rolling-ball-baseline"></a>
</h3>
<p>The rolling ball algorithm “rolls” a ball of specified radius under
the spectrum to estimate the baseline:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec_rolling</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_baseline_rolling.html">step_measure_baseline_rolling</a></span><span class="op">(</span>window_size <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rolling_data</span> <span class="op">&lt;-</span> <span class="fu">get_internal</span><span class="op">(</span><span class="va">rec_rolling</span><span class="op">)</span></span>
<span><span class="fu">plot_spectra</span><span class="op">(</span><span class="va">rolling_data</span>, <span class="st">"Rolling Ball Baseline Correction"</span>,</span>
<span>             <span class="st">"Window size = 50"</span><span class="op">)</span></span></code></pre></div>
<p><img src="preprocessing_files/figure-html/rolling-baseline-1.png" class="r-plt" alt="" width="672"></p>
<p>Key parameters: - <code>window_size</code>: Diameter of the rolling
ball (larger = smoother baseline) - <code>smoothing</code>: Amount of
smoothing applied to the estimated baseline</p>
</div>
<div class="section level3">
<h3 id="airpls-baseline">airPLS baseline<a class="anchor" aria-label="anchor" href="#airpls-baseline"></a>
</h3>
<p>Adaptive Iteratively Reweighted Penalized Least Squares adapts to
complex, varying baselines:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec_airpls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_baseline_airpls.html">step_measure_baseline_airpls</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="fl">1e5</span>, max_iter <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span></span>
<span><span class="va">airpls_data</span> <span class="op">&lt;-</span> <span class="fu">get_internal</span><span class="op">(</span><span class="va">rec_airpls</span><span class="op">)</span></span>
<span><span class="fu">plot_spectra</span><span class="op">(</span><span class="va">airpls_data</span>, <span class="st">"airPLS Baseline Correction"</span>,</span>
<span>             <span class="st">"lambda = 1e5"</span><span class="op">)</span></span></code></pre></div>
<p><img src="preprocessing_files/figure-html/airpls-baseline-1.png" class="r-plt" alt="" width="672"></p>
<p>The <code>lambda</code> parameter controls smoothness (larger =
smoother baseline) and is tunable with dials.</p>
</div>
<div class="section level3">
<h3 id="snip-baseline">SNIP baseline<a class="anchor" aria-label="anchor" href="#snip-baseline"></a>
</h3>
<p>Statistics-sensitive Non-linear Iterative Peak-clipping (SNIP) is
well-suited for spectroscopy with sharp peaks:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec_snip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_baseline_snip.html">step_measure_baseline_snip</a></span><span class="op">(</span>iterations <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span></span>
<span><span class="va">snip_data</span> <span class="op">&lt;-</span> <span class="fu">get_internal</span><span class="op">(</span><span class="va">rec_snip</span><span class="op">)</span></span>
<span><span class="fu">plot_spectra</span><span class="op">(</span><span class="va">snip_data</span>, <span class="st">"SNIP Baseline Correction"</span>,</span>
<span>             <span class="st">"30 iterations, decreasing window"</span><span class="op">)</span></span></code></pre></div>
<p><img src="preprocessing_files/figure-html/snip-baseline-1.png" class="r-plt" alt="" width="672"></p>
<p>Key parameters: - <code>iterations</code>: Number of clipping
iterations (more = more aggressive baseline removal) -
<code>decreasing</code>: Whether to decrease window size with iterations
(recommended for peaks)</p>
</div>
</div>
<div class="section level2">
<h2 id="standard-normal-variate-snv">Standard Normal Variate (SNV)<a class="anchor" aria-label="anchor" href="#standard-normal-variate-snv"></a>
</h2>
<div class="section level3">
<h3 id="what-it-does-1">What it does<a class="anchor" aria-label="anchor" href="#what-it-does-1"></a>
</h3>
<p>SNV normalizes each spectrum independently by centering and
scaling:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>N</mi><mi>V</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mrow><mi>x</mi><mo>−</mo><mover><mi>x</mi><mo accent="true">‾</mo></mover></mrow><msub><mi>s</mi><mi>x</mi></msub></mfrac></mrow><annotation encoding="application/x-tex">SNV(x) = \frac{x - \bar{x}}{s_x}</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>x</mi><mo accent="true">‾</mo></mover><annotation encoding="application/x-tex">\bar{x}</annotation></semantics></math>
is the spectrum’s mean and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>s</mi><mi>x</mi></msub><annotation encoding="application/x-tex">s_x</annotation></semantics></math>
is its standard deviation.</p>
</div>
<div class="section level3">
<h3 id="when-to-use-it-1">When to use it<a class="anchor" aria-label="anchor" href="#when-to-use-it-1"></a>
</h3>
<ul>
<li>Remove multiplicative scatter effects</li>
<li>Correct for path length variations</li>
<li>Normalize spectra to similar magnitude</li>
</ul>
<p>SNV is particularly effective for diffuse reflectance spectra where
particle size causes scatter variations.</p>
</div>
<div class="section level3">
<h3 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h3>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec_snv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_snv.html">step_measure_snv</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">snv_data</span> <span class="op">&lt;-</span> <span class="fu">get_internal</span><span class="op">(</span><span class="va">rec_snv</span><span class="op">)</span></span>
<span><span class="fu">plot_spectra</span><span class="op">(</span><span class="va">snv_data</span>, <span class="st">"After SNV Normalization"</span>, <span class="st">"Each spectrum has mean = 0 and sd = 1"</span><span class="op">)</span></span></code></pre></div>
<p><img src="preprocessing_files/figure-html/snv-example-1.png" class="r-plt" alt="" width="672"></p>
</div>
<div class="section level3">
<h3 id="combining-with-derivatives">Combining with derivatives<a class="anchor" aria-label="anchor" href="#combining-with-derivatives"></a>
</h3>
<p>SNV is often combined with Savitzky-Golay derivatives. The order
matters:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Derivative then SNV (more common)</span></span>
<span><span class="va">rec_d1_snv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_savitzky_golay.html">step_measure_savitzky_golay</a></span><span class="op">(</span>window_side <span class="op">=</span> <span class="fl">5</span>, differentiation_order <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_snv.html">step_measure_snv</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plot_spectra</span><span class="op">(</span><span class="fu">get_internal</span><span class="op">(</span><span class="va">rec_d1_snv</span><span class="op">)</span>, <span class="st">"1st Derivative + SNV"</span>,</span>
<span>             <span class="st">"Combined baseline removal and scatter correction"</span><span class="op">)</span></span></code></pre></div>
<p><img src="preprocessing_files/figure-html/snv-combination-1.png" class="r-plt" alt="" width="672"></p>
</div>
</div>
<div class="section level2">
<h2 id="multiplicative-scatter-correction-msc">Multiplicative Scatter Correction (MSC)<a class="anchor" aria-label="anchor" href="#multiplicative-scatter-correction-msc"></a>
</h2>
<div class="section level3">
<h3 id="what-it-does-2">What it does<a class="anchor" aria-label="anchor" href="#what-it-does-2"></a>
</h3>
<p>MSC aligns each spectrum to a reference spectrum (typically the mean
of all training spectra) by correcting for additive and multiplicative
effects:</p>
<ol style="list-style-type: decimal">
<li>Fit each spectrum
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>x</mi><mi>i</mi></msub><annotation encoding="application/x-tex">x_i</annotation></semantics></math>
to the reference
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>x</mi><mi>r</mi></msub><annotation encoding="application/x-tex">x_r</annotation></semantics></math>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub><mo>=</mo><msub><mi>m</mi><mi>i</mi></msub><mo>⋅</mo><msub><mi>x</mi><mi>r</mi></msub><mo>+</mo><msub><mi>a</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i = m_i \cdot x_r + a_i</annotation></semantics></math>
</li>
<li>Correct:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>S</mi><mi>C</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mrow><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><msub><mi>a</mi><mi>i</mi></msub></mrow><msub><mi>m</mi><mi>i</mi></msub></mfrac></mrow><annotation encoding="application/x-tex">MSC(x_i) = \frac{x_i - a_i}{m_i}</annotation></semantics></math>
</li>
</ol>
</div>
<div class="section level3">
<h3 id="when-to-use-it-2">When to use it<a class="anchor" aria-label="anchor" href="#when-to-use-it-2"></a>
</h3>
<ul>
<li>Similar applications to SNV</li>
<li>When you have a good reference spectrum</li>
<li>Often slightly better than SNV for scatter correction</li>
</ul>
</div>
<div class="section level3">
<h3 id="how-it-differs-from-snv">How it differs from SNV<a class="anchor" aria-label="anchor" href="#how-it-differs-from-snv"></a>
</h3>
<ul>
<li>
<strong>SNV</strong>: Each spectrum normalized independently (no
reference needed)</li>
<li>
<strong>MSC</strong>: All spectra aligned to a common reference
(learns reference during prep)</li>
</ul>
<p>This means MSC is a <em>trained</em> step - it learns the reference
spectrum from training data and applies the same reference to new
data.</p>
</div>
<div class="section level3">
<h3 id="example-1">Example<a class="anchor" aria-label="anchor" href="#example-1"></a>
</h3>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec_msc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_msc.html">step_measure_msc</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">msc_data</span> <span class="op">&lt;-</span> <span class="fu">get_internal</span><span class="op">(</span><span class="va">rec_msc</span><span class="op">)</span></span>
<span><span class="fu">plot_spectra</span><span class="op">(</span><span class="va">msc_data</span>, <span class="st">"After MSC"</span>, <span class="st">"Spectra aligned to mean reference"</span><span class="op">)</span></span></code></pre></div>
<p><img src="preprocessing_files/figure-html/msc-example-1.png" class="r-plt" alt="" width="672"></p>
</div>
<div class="section level3">
<h3 id="comparing-snv-and-msc">Comparing SNV and MSC<a class="anchor" aria-label="anchor" href="#comparing-snv-and-msc"></a>
</h3>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_snv</span> <span class="op">&lt;-</span> <span class="fu">plot_spectra</span><span class="op">(</span><span class="fu">get_internal</span><span class="op">(</span><span class="va">rec_snv</span><span class="op">)</span>, <span class="st">"SNV"</span><span class="op">)</span></span>
<span><span class="va">p_msc</span> <span class="op">&lt;-</span> <span class="fu">plot_spectra</span><span class="op">(</span><span class="fu">get_internal</span><span class="op">(</span><span class="va">rec_msc</span><span class="op">)</span>, <span class="st">"MSC"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_snv</span> <span class="op">/</span> <span class="va">p_msc</span></span></code></pre></div>
<p><img src="preprocessing_files/figure-html/snv-vs-msc-1.png" class="r-plt" alt="" width="672"></p>
<p>Both methods produce similar results for this dataset. In practice,
try both and compare model performance.</p>
</div>
</div>
<div class="section level2">
<h2 id="sample-wise-normalization">Sample-wise Normalization<a class="anchor" aria-label="anchor" href="#sample-wise-normalization"></a>
</h2>
<p>The measure package provides several sample-wise normalization
methods that normalize each spectrum independently. Unlike SNV/MSC which
address scatter, these methods adjust for differences in total signal
intensity.</p>
<div class="section level3">
<h3 id="available-methods-1">Available methods<a class="anchor" aria-label="anchor" href="#available-methods-1"></a>
</h3>
<table class="table">
<colgroup>
<col width="24%">
<col width="36%">
<col width="40%">
</colgroup>
<thead><tr class="header">
<th>Step</th>
<th>Formula</th>
<th>Use case</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code><a href="../reference/step_measure_normalize_sum.html">step_measure_normalize_sum()</a></code></td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi>/</mi><mo>∑</mo><mi>x</mi></mrow><annotation encoding="application/x-tex">x / \sum x</annotation></semantics></math></td>
<td>Total intensity normalization</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_normalize_max.html">step_measure_normalize_max()</a></code></td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi>/</mi><mo>max</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">x / \max(x)</annotation></semantics></math></td>
<td>Peak-focused analysis</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/step_measure_normalize_range.html">step_measure_normalize_range()</a></code></td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo>−</mo><mo>min</mo><mo stretchy="true" form="postfix">)</mo></mrow><mi>/</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo>max</mo><mo>−</mo><mo>min</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">(x - \min) / (\max - \min)</annotation></semantics></math></td>
<td>Scale to 0-1 range</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_normalize_vector.html">step_measure_normalize_vector()</a></code></td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi>/</mi><mo stretchy="false" form="postfix">∥</mo><mi>x</mi><msub><mo stretchy="false" form="postfix">∥</mo><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">x / \|x\|_2</annotation></semantics></math></td>
<td>L2/Euclidean normalization</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/step_measure_normalize_auc.html">step_measure_normalize_auc()</a></code></td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi>/</mi><mi>A</mi><mi>U</mi><mi>C</mi></mrow><annotation encoding="application/x-tex">x / AUC</annotation></semantics></math></td>
<td>Chromatography (area under curve)</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_normalize_peak.html">step_measure_normalize_peak()</a></code></td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mi>/</mi><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mtext mathvariant="normal">region</mtext><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">x / f(\text{region})</annotation></semantics></math></td>
<td>Internal standard normalization</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="sum-normalization">Sum normalization<a class="anchor" aria-label="anchor" href="#sum-normalization"></a>
</h3>
<p>Divides each spectrum by its total intensity. After transformation,
all spectra sum to 1:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec_norm_sum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_normalize_sum.html">step_measure_normalize_sum</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plot_spectra</span><span class="op">(</span><span class="fu">get_internal</span><span class="op">(</span><span class="va">rec_norm_sum</span><span class="op">)</span>, <span class="st">"Sum Normalized"</span>,</span>
<span>             <span class="st">"Each spectrum sums to 1"</span><span class="op">)</span></span></code></pre></div>
<p><img src="preprocessing_files/figure-html/normalize-sum-1.png" class="r-plt" alt="" width="672"></p>
</div>
<div class="section level3">
<h3 id="max-normalization">Max normalization<a class="anchor" aria-label="anchor" href="#max-normalization"></a>
</h3>
<p>Divides each spectrum by its maximum value, useful for peak-focused
analysis:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec_norm_max</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_normalize_max.html">step_measure_normalize_max</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plot_spectra</span><span class="op">(</span><span class="fu">get_internal</span><span class="op">(</span><span class="va">rec_norm_max</span><span class="op">)</span>, <span class="st">"Max Normalized"</span>,</span>
<span>             <span class="st">"Each spectrum has maximum = 1"</span><span class="op">)</span></span></code></pre></div>
<p><img src="preprocessing_files/figure-html/normalize-max-1.png" class="r-plt" alt="" width="672"></p>
</div>
<div class="section level3">
<h3 id="peak-region-normalization-tunable">Peak region normalization (tunable)<a class="anchor" aria-label="anchor" href="#peak-region-normalization-tunable"></a>
</h3>
<p>When you have an internal standard at a known location, use
<code><a href="../reference/step_measure_normalize_peak.html">step_measure_normalize_peak()</a></code> to normalize by a specific
region:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec_norm_peak</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_normalize_peak.html">step_measure_normalize_peak</a></span><span class="op">(</span></span>
<span>    location_min <span class="op">=</span> <span class="fl">900</span>,</span>
<span>    location_max <span class="op">=</span> <span class="fl">950</span>,</span>
<span>    method <span class="op">=</span> <span class="st">"mean"</span>  <span class="co"># or "max" or "integral"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu">plot_spectra</span><span class="op">(</span><span class="fu">get_internal</span><span class="op">(</span><span class="va">rec_norm_peak</span><span class="op">)</span>, <span class="st">"Peak Region Normalized"</span>,</span>
<span>             <span class="st">"Normalized by mean of region 900-950"</span><span class="op">)</span></span></code></pre></div>
<p><img src="preprocessing_files/figure-html/normalize-peak-1.png" class="r-plt" alt="" width="672"></p>
<p>The <code>location_min</code> and <code>location_max</code>
parameters are tunable:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec_tunable_peak</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_normalize_peak.html">step_measure_normalize_peak</a></span><span class="op">(</span></span>
<span>    location_min <span class="op">=</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/tune.html" class="external-link">tune</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    location_max <span class="op">=</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/tune.html" class="external-link">tune</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    method <span class="op">=</span> <span class="st">"mean"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_output_wide.html">step_measure_output_wide</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="variable-wise-scaling">Variable-wise Scaling<a class="anchor" aria-label="anchor" href="#variable-wise-scaling"></a>
</h2>
<p>While sample-wise methods normalize each spectrum independently,
variable-wise scaling operates across samples at each measurement
location. These methods <strong>learn statistics from training
data</strong> and apply them consistently to new data.</p>
<div class="section level3">
<h3 id="when-to-use-variable-wise-scaling">When to use variable-wise scaling<a class="anchor" aria-label="anchor" href="#when-to-use-variable-wise-scaling"></a>
</h3>
<ul>
<li>
<strong>Before PCA/PLS</strong>: Centering is essential; scaling
equalizes variable importance</li>
<li>
<strong>When variables have different scales</strong>: Auto-scaling
gives equal weight to all locations</li>
<li>
<strong>For metabolomics data</strong>: Pareto scaling is common
practice</li>
</ul>
</div>
<div class="section level3">
<h3 id="mean-centering">Mean centering<a class="anchor" aria-label="anchor" href="#mean-centering"></a>
</h3>
<p><code><a href="../reference/step_measure_center.html">step_measure_center()</a></code> subtracts the column mean at each
location:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec_center</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_center.html">step_measure_center</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">center_data</span> <span class="op">&lt;-</span> <span class="fu">get_internal</span><span class="op">(</span><span class="va">rec_center</span><span class="op">)</span></span>
<span><span class="fu">plot_spectra</span><span class="op">(</span><span class="va">center_data</span>, <span class="st">"Mean Centered"</span>,</span>
<span>             <span class="st">"Column means are zero"</span><span class="op">)</span></span></code></pre></div>
<p><img src="preprocessing_files/figure-html/center-1.png" class="r-plt" alt="" width="672"></p>
</div>
<div class="section level3">
<h3 id="auto-scaling-z-score">Auto-scaling (z-score)<a class="anchor" aria-label="anchor" href="#auto-scaling-z-score"></a>
</h3>
<p><code><a href="../reference/step_measure_scale_auto.html">step_measure_scale_auto()</a></code> centers and scales to unit
variance at each location:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec_auto</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_scale_auto.html">step_measure_scale_auto</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">auto_data</span> <span class="op">&lt;-</span> <span class="fu">get_internal</span><span class="op">(</span><span class="va">rec_auto</span><span class="op">)</span></span>
<span><span class="fu">plot_spectra</span><span class="op">(</span><span class="va">auto_data</span>, <span class="st">"Auto-Scaled (Z-Score)"</span>,</span>
<span>             <span class="st">"Column means = 0, SDs = 1"</span><span class="op">)</span></span></code></pre></div>
<p><img src="preprocessing_files/figure-html/scale-auto-1.png" class="r-plt" alt="" width="672"></p>
</div>
<div class="section level3">
<h3 id="pareto-scaling">Pareto scaling<a class="anchor" aria-label="anchor" href="#pareto-scaling"></a>
</h3>
<p><code><a href="../reference/step_measure_scale_pareto.html">step_measure_scale_pareto()</a></code> divides by the square root
of the standard deviation - a compromise between no scaling and
auto-scaling:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec_pareto</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_scale_pareto.html">step_measure_scale_pareto</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pareto_data</span> <span class="op">&lt;-</span> <span class="fu">get_internal</span><span class="op">(</span><span class="va">rec_pareto</span><span class="op">)</span></span>
<span><span class="fu">plot_spectra</span><span class="op">(</span><span class="va">pareto_data</span>, <span class="st">"Pareto Scaled"</span>,</span>
<span>             <span class="st">"Reduces influence of large values while preserving fold changes"</span><span class="op">)</span></span></code></pre></div>
<p><img src="preprocessing_files/figure-html/scale-pareto-1.png" class="r-plt" alt="" width="672"></p>
</div>
<div class="section level3">
<h3 id="comparing-scaling-methods">Comparing scaling methods<a class="anchor" aria-label="anchor" href="#comparing-scaling-methods"></a>
</h3>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_raw</span> <span class="op">&lt;-</span> <span class="fu">plot_spectra</span><span class="op">(</span><span class="va">raw_data</span>, <span class="st">"Raw"</span><span class="op">)</span></span>
<span><span class="va">p_center</span> <span class="op">&lt;-</span> <span class="fu">plot_spectra</span><span class="op">(</span><span class="va">center_data</span>, <span class="st">"Centered"</span><span class="op">)</span></span>
<span><span class="va">p_auto</span> <span class="op">&lt;-</span> <span class="fu">plot_spectra</span><span class="op">(</span><span class="va">auto_data</span>, <span class="st">"Auto-Scaled"</span><span class="op">)</span></span>
<span><span class="va">p_pareto</span> <span class="op">&lt;-</span> <span class="fu">plot_spectra</span><span class="op">(</span><span class="va">pareto_data</span>, <span class="st">"Pareto Scaled"</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">p_raw</span> <span class="op">+</span> <span class="va">p_center</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">p_auto</span> <span class="op">+</span> <span class="va">p_pareto</span><span class="op">)</span></span></code></pre></div>
<p><img src="preprocessing_files/figure-html/scale-comparison-1.png" class="r-plt" alt="" width="672"></p>
</div>
<div class="section level3">
<h3 id="learned-parameters">Learned parameters<a class="anchor" aria-label="anchor" href="#learned-parameters"></a>
</h3>
<p>Variable-wise scaling steps store learned parameters that can be
examined after training:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec_prepped</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep</a></span><span class="op">(</span><span class="va">rec_auto</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># View learned parameters</span></span>
<span><span class="va">tidy_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">rec_prepped</span>, number <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">tidy_params</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 5</span></span></span>
<span><span class="co">#&gt;   terms     location  mean    sd id                      </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> .measures     850   2.81 0.411 measure_scale_auto_hncrU</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> .measures     852.  2.81 0.413 measure_scale_auto_hncrU</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> .measures     854.  2.81 0.416 measure_scale_auto_hncrU</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> .measures     856.  2.82 0.418 measure_scale_auto_hncrU</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> .measures     858.  2.82 0.421 measure_scale_auto_hncrU</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> .measures     860.  2.82 0.424 measure_scale_auto_hncrU</span></span>
<span></span>
<span><span class="co"># Plot the learned means and SDs</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">tidy_params</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">location</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">mean</span> <span class="op">-</span> <span class="va">sd</span>, ymax <span class="op">=</span> <span class="va">mean</span> <span class="op">+</span> <span class="va">sd</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span>, fill <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Wavelength"</span>, y <span class="op">=</span> <span class="st">"Value"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Learned Parameters from Auto-Scaling"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Mean ± 1 SD at each wavelength"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="preprocessing_files/figure-html/tidy-scaling-1.png" class="r-plt" alt="" width="672"></p>
</div>
</div>
<div class="section level2">
<h2 id="custom-transformations">Custom Transformations<a class="anchor" aria-label="anchor" href="#custom-transformations"></a>
</h2>
<div class="section level3">
<h3 id="when-built-in-steps-arent-enough">When built-in steps aren’t enough<a class="anchor" aria-label="anchor" href="#when-built-in-steps-arent-enough"></a>
</h3>
<p>The built-in preprocessing steps cover the most common operations,
but you may need domain-specific transformations:</p>
<ul>
<li>Custom baseline correction algorithms</li>
<li>Instrument-specific corrections</li>
<li>Experimental preprocessing techniques</li>
<li>Transformations from specialized packages</li>
</ul>
<p><code><a href="../reference/step_measure_map.html">step_measure_map()</a></code> provides an “escape hatch” for
applying any custom function to your measurements while staying within
the recipes framework.</p>
</div>
<div class="section level3">
<h3 id="using-step_measure_map">Using step_measure_map()<a class="anchor" aria-label="anchor" href="#using-step_measure_map"></a>
</h3>
<p>The function you provide must accept a tibble with
<code>location</code> and <code>value</code> columns and return a tibble
with the same structure:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example: Shift spectra to start at zero</span></span>
<span><span class="va">zero_baseline</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span><span class="va">x</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">value</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></span>
<span><span class="va">x</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">rec_custom</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span><span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span><span class="fu"><a href="../reference/step_measure_map.html">step_measure_map</a></span><span class="op">(</span><span class="va">zero_baseline</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span><span class="fu"><a href="../reference/step_measure_snv.html">step_measure_snv</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plot_spectra</span><span class="op">(</span><span class="fu">get_internal</span><span class="op">(</span><span class="va">rec_custom</span><span class="op">)</span>, <span class="st">"Custom Zero-Baseline + SNV"</span><span class="op">)</span></span></code></pre></div>
<p><img src="preprocessing_files/figure-html/custom-step-1.png" class="r-plt" alt="" width="672"></p>
</div>
<div class="section level3">
<h3 id="formula-syntax-for-inline-transformations">Formula syntax for inline transformations<a class="anchor" aria-label="anchor" href="#formula-syntax-for-inline-transformations"></a>
</h3>
<p>For simple transformations, use formula syntax instead of defining a
separate function:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rec_inline</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span><span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span><span class="fu"><a href="../reference/step_measure_map.html">step_measure_map</a></span><span class="op">(</span><span class="op">~</span> <span class="op">{</span></span>
<span><span class="co"># Log transform (common for absorbance data)</span></span>
<span><span class="va">.x</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log1p</a></span><span class="op">(</span><span class="va">.x</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></span>
<span><span class="va">.x</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="passing-additional-arguments">Passing additional arguments<a class="anchor" aria-label="anchor" href="#passing-additional-arguments"></a>
</h3>
<p>You can pass extra arguments to your transformation function:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># A function with configurable parameters</span></span>
<span><span class="va">robust_scale</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">center_fn</span> <span class="op">=</span> <span class="va">median</span>, <span class="va">scale_fn</span> <span class="op">=</span> <span class="va">mad</span><span class="op">)</span> <span class="op">{</span></span>
<span><span class="va">x</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">value</span> <span class="op">-</span> <span class="fu">center_fn</span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu">scale_fn</span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></span>
<span><span class="va">x</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Use with custom parameters</span></span>
<span><span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span><span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span><span class="fu"><a href="../reference/step_measure_map.html">step_measure_map</a></span><span class="op">(</span><span class="va">robust_scale</span>, center_fn <span class="op">=</span> <span class="va">mean</span>, scale_fn <span class="op">=</span> <span class="va">sd</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="prototyping-with-measure_map">Prototyping with measure_map()<a class="anchor" aria-label="anchor" href="#prototyping-with-measure_map"></a>
</h3>
<p>When developing a custom transformation, it helps to prototype
interactively before putting it in a recipe. Use
<code><a href="../reference/measure_map.html">measure_map()</a></code> for exploration:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># First, get data in internal format</span></span>
<span><span class="va">rec_internal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span><span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span>, location_values <span class="op">=</span> <span class="va">wavelengths</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span><span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">baked_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html" class="external-link">bake</a></span><span class="op">(</span><span class="va">rec_internal</span>, new_data <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Prototype your transformation</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/measure_map.html">measure_map</a></span><span class="op">(</span><span class="va">baked_data</span>, <span class="op">~</span> <span class="op">{</span></span>
<span><span class="co"># Experiment with different approaches</span></span>
<span><span class="va">.x</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="va">.x</span><span class="op">$</span><span class="va">value</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">.x</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></span>
<span><span class="va">.x</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check results</span></span>
<span><span class="va">result</span><span class="op">$</span><span class="va">.measures</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; &lt;measure_tbl [100 x 2]&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 100 × 2</span></span></span>
<span><span class="co">#&gt;    location  value</span></span>
<span><span class="co">#&gt;       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     850  -<span style="color: #BB0000;">0.317</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     852. -<span style="color: #BB0000;">0.316</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     854. -<span style="color: #BB0000;">0.316</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     856. -<span style="color: #BB0000;">0.315</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     858. -<span style="color: #BB0000;">0.314</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     860. -<span style="color: #BB0000;">0.314</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     862. -<span style="color: #BB0000;">0.312</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     864. -<span style="color: #BB0000;">0.311</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     866. -<span style="color: #BB0000;">0.309</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     868. -<span style="color: #BB0000;">0.307</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 90 more rows</span></span></span></code></pre></div>
<p>Once your transformation works correctly, move it into
<code><a href="../reference/step_measure_map.html">step_measure_map()</a></code> for production use. This ensures the
transformation is:</p>
<ul>
<li>Applied consistently during <code><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep()</a></code> and
<code><a href="https://recipes.tidymodels.org/reference/bake.html" class="external-link">bake()</a></code>
</li>
<li>Included when bundling recipes into workflows</li>
<li>Reproducible across sessions</li>
</ul>
</div>
<div class="section level3">
<h3 id="handling-problematic-samples">Handling problematic samples<a class="anchor" aria-label="anchor" href="#handling-problematic-samples"></a>
</h3>
<p>Use <code><a href="../reference/measure_map_safely.html">measure_map_safely()</a></code> when exploring data that might
have problematic samples:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># A transformation that might fail for some samples</span></span>
<span><span class="va">risky_transform</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Non-positive values!"</span><span class="op">)</span></span>
<span><span class="va">x</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></span>
<span><span class="va">x</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Errors are captured, not thrown</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/measure_map_safely.html">measure_map_safely</a></span><span class="op">(</span><span class="va">baked_data</span>, <span class="va">risky_transform</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check which samples failed</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">errors</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">errors</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># result$result contains the data with successful transforms</span></span>
<span><span class="co"># (failed samples keep their original values)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="understanding-your-data-with-measure_summarize">Understanding your data with measure_summarize()<a class="anchor" aria-label="anchor" href="#understanding-your-data-with-measure_summarize"></a>
</h3>
<p>Before preprocessing, it’s often helpful to compute summary
statistics across samples:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute mean and SD at each wavelength</span></span>
<span><span class="va">summary_stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/measure_summarize.html">measure_summarize</a></span><span class="op">(</span><span class="va">baked_data</span><span class="op">)</span></span>
<span><span class="va">summary_stats</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 100 × 3</span></span></span>
<span><span class="co">#&gt;    location  mean    sd</span></span>
<span><span class="co">#&gt;       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     850   2.81 0.411</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     852.  2.81 0.413</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     854.  2.81 0.416</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     856.  2.82 0.418</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     858.  2.82 0.421</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     860.  2.82 0.424</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     862.  2.83 0.426</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     864.  2.83 0.429</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     866.  2.83 0.432</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     868.  2.84 0.434</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 90 more rows</span></span></span>
<span></span>
<span><span class="co"># Visualize the mean spectrum with variability</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">summary_stats</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">location</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">mean</span> <span class="op">-</span> <span class="va">sd</span>, ymax <span class="op">=</span> <span class="va">mean</span> <span class="op">+</span> <span class="va">sd</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Wavelength"</span>, y <span class="op">=</span> <span class="st">"Signal"</span>, title <span class="op">=</span> <span class="st">"Mean Spectrum ± 1 SD"</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="preprocessing_files/figure-html/summarize-example-1.png" class="r-plt" alt="" width="672"></p>
<p>This can help identify: - Wavelength regions with high variability -
Potential outliers - Reference spectra for custom corrections</p>
</div>
</div>
<div class="section level2">
<h2 id="preprocessing-pipelines">Preprocessing pipelines<a class="anchor" aria-label="anchor" href="#preprocessing-pipelines"></a>
</h2>
<div class="section level3">
<h3 id="common-combinations">Common combinations<a class="anchor" aria-label="anchor" href="#common-combinations"></a>
</h3>
<p>Here are some commonly used preprocessing pipelines:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Pipeline 1: Basic scatter correction</span></span>
<span><span class="va">pipe1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_snv.html">step_measure_snv</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_output_wide.html">step_measure_output_wide</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Pipeline 2: Derivative + normalization</span></span>
<span><span class="va">pipe2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_savitzky_golay.html">step_measure_savitzky_golay</a></span><span class="op">(</span>window_side <span class="op">=</span> <span class="fl">5</span>, differentiation_order <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_snv.html">step_measure_snv</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_output_wide.html">step_measure_output_wide</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Pipeline 3: Second derivative (often enough on its own)</span></span>
<span><span class="va">pipe3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_savitzky_golay.html">step_measure_savitzky_golay</a></span><span class="op">(</span>window_side <span class="op">=</span> <span class="fl">7</span>, differentiation_order <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_output_wide.html">step_measure_output_wide</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Pipeline 4: MSC + smoothing</span></span>
<span><span class="va">pipe4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_msc.html">step_measure_msc</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_savitzky_golay.html">step_measure_savitzky_golay</a></span><span class="op">(</span>window_side <span class="op">=</span> <span class="fl">5</span>, differentiation_order <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_output_wide.html">step_measure_output_wide</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Pipeline 5: For PCA/PLS - SNV + centering</span></span>
<span><span class="va">pipe5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_snv.html">step_measure_snv</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_center.html">step_measure_center</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_output_wide.html">step_measure_output_wide</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Pipeline 6: Metabolomics-style with Pareto scaling</span></span>
<span><span class="va">pipe6</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">water</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">meats</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_input_wide.html">step_measure_input_wide</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"x_"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_normalize_sum.html">step_measure_normalize_sum</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_scale_pareto.html">step_measure_scale_pareto</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_measure_output_wide.html">step_measure_output_wide</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="order-of-operations">Order of operations<a class="anchor" aria-label="anchor" href="#order-of-operations"></a>
</h3>
<p>The order of preprocessing steps matters. General guidelines:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Derivatives first</strong>: Apply Savitzky-Golay derivatives
before other transformations</li>
<li>
<strong>Sample-wise normalization before variable-wise
scaling</strong>: Normalize spectra (SNV, MSC, normalize_*) before
centering/scaling</li>
<li>
<strong>Center/scale last</strong>: Variable-wise scaling should
typically be the final step before modeling</li>
<li>
<strong>Keep it simple</strong>: Often, a single well-chosen step
outperforms complex pipelines</li>
</ol>
<p>A typical order might be:</p>
<pre><code>Derivatives → Sample normalization (SNV/MSC) → Variable scaling (center/auto-scale)</code></pre>
</div>
</div>
<div class="section level2">
<h2 id="summary-table">Summary table<a class="anchor" aria-label="anchor" href="#summary-table"></a>
</h2>
<div class="section level3">
<h3 id="filtering-and-scatter-correction">Filtering and Scatter Correction<a class="anchor" aria-label="anchor" href="#filtering-and-scatter-correction"></a>
</h3>
<table class="table">
<colgroup>
<col width="25%">
<col width="33%">
<col width="41%">
</colgroup>
<thead><tr class="header">
<th>Step</th>
<th>Effect</th>
<th>Use when</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>step_measure_savitzky_golay(order=0)</code></td>
<td>Smoothing</td>
<td>High-frequency noise</td>
</tr>
<tr class="even">
<td><code>step_measure_savitzky_golay(order=1)</code></td>
<td>1st derivative</td>
<td>Baseline offsets</td>
</tr>
<tr class="odd">
<td><code>step_measure_savitzky_golay(order=2)</code></td>
<td>2nd derivative</td>
<td>Linear baselines</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_snv.html">step_measure_snv()</a></code></td>
<td>Row normalization</td>
<td>Scatter, path length</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/step_measure_msc.html">step_measure_msc()</a></code></td>
<td>Align to reference</td>
<td>Scatter (supervised)</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="spectral-math">Spectral Math<a class="anchor" aria-label="anchor" href="#spectral-math"></a>
</h3>
<table class="table">
<colgroup>
<col width="25%">
<col width="33%">
<col width="41%">
</colgroup>
<thead><tr class="header">
<th>Step</th>
<th>Effect</th>
<th>Use when</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code><a href="../reference/step_measure_absorbance.html">step_measure_absorbance()</a></code></td>
<td>T → A</td>
<td>Convert transmittance</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_transmittance.html">step_measure_transmittance()</a></code></td>
<td>A → T</td>
<td>Convert absorbance</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/step_measure_log.html">step_measure_log()</a></code></td>
<td>Log transform</td>
<td>Variance stabilization</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_kubelka_munk.html">step_measure_kubelka_munk()</a></code></td>
<td>K-M transform</td>
<td>Diffuse reflectance</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/step_measure_derivative.html">step_measure_derivative()</a></code></td>
<td>Finite difference</td>
<td>Fast unsmoothed derivative</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_derivative_gap.html">step_measure_derivative_gap()</a></code></td>
<td>Gap derivative</td>
<td>NIR chemometrics</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="sample-wise-normalization-1">Sample-wise Normalization<a class="anchor" aria-label="anchor" href="#sample-wise-normalization-1"></a>
</h3>
<table class="table">
<colgroup>
<col width="25%">
<col width="33%">
<col width="41%">
</colgroup>
<thead><tr class="header">
<th>Step</th>
<th>Effect</th>
<th>Use when</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code><a href="../reference/step_measure_normalize_sum.html">step_measure_normalize_sum()</a></code></td>
<td>Divide by sum</td>
<td>Total intensity differences</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_normalize_max.html">step_measure_normalize_max()</a></code></td>
<td>Divide by max</td>
<td>Peak-focused analysis</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/step_measure_normalize_range.html">step_measure_normalize_range()</a></code></td>
<td>Scale to 0-1</td>
<td>Neural networks, visualization</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_normalize_vector.html">step_measure_normalize_vector()</a></code></td>
<td>L2 normalization</td>
<td>Euclidean distance methods</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/step_measure_normalize_auc.html">step_measure_normalize_auc()</a></code></td>
<td>Divide by AUC</td>
<td>Chromatography</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_normalize_peak.html">step_measure_normalize_peak()</a></code></td>
<td>Divide by region</td>
<td>Internal standard</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="variable-wise-scaling-1">Variable-wise Scaling<a class="anchor" aria-label="anchor" href="#variable-wise-scaling-1"></a>
</h3>
<table class="table">
<colgroup>
<col width="25%">
<col width="33%">
<col width="41%">
</colgroup>
<thead><tr class="header">
<th>Step</th>
<th>Effect</th>
<th>Use when</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code><a href="../reference/step_measure_center.html">step_measure_center()</a></code></td>
<td>Subtract mean</td>
<td>Before PCA/PLS (essential)</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_scale_auto.html">step_measure_scale_auto()</a></code></td>
<td>Z-score</td>
<td>Equal variable importance</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/step_measure_scale_pareto.html">step_measure_scale_pareto()</a></code></td>
<td>Pareto scaling</td>
<td>Metabolomics</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_scale_range.html">step_measure_scale_range()</a></code></td>
<td>Range scaling</td>
<td>Bounded scaling</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/step_measure_scale_vast.html">step_measure_scale_vast()</a></code></td>
<td>VAST scaling</td>
<td>Variable stability focus</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="region-operations-1">Region Operations<a class="anchor" aria-label="anchor" href="#region-operations-1"></a>
</h3>
<table class="table">
<colgroup>
<col width="25%">
<col width="33%">
<col width="41%">
</colgroup>
<thead><tr class="header">
<th>Step</th>
<th>Effect</th>
<th>Use when</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code><a href="../reference/step_measure_trim.html">step_measure_trim()</a></code></td>
<td>Keep x-range</td>
<td>Focus on region of interest</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_exclude.html">step_measure_exclude()</a></code></td>
<td>Remove x-ranges</td>
<td>Remove solvent peaks, artifacts</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/step_measure_resample.html">step_measure_resample()</a></code></td>
<td>Interpolate to grid</td>
<td>Align instruments, reduce density</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="smoothing-noise-reduction">Smoothing &amp; Noise Reduction<a class="anchor" aria-label="anchor" href="#smoothing-noise-reduction"></a>
</h3>
<table class="table">
<colgroup>
<col width="25%">
<col width="33%">
<col width="41%">
</colgroup>
<thead><tr class="header">
<th>Step</th>
<th>Effect</th>
<th>Use when</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code><a href="../reference/step_measure_smooth_ma.html">step_measure_smooth_ma()</a></code></td>
<td>Moving average</td>
<td>Simple noise reduction</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_smooth_median.html">step_measure_smooth_median()</a></code></td>
<td>Median filter</td>
<td>Spike removal, robust smoothing</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/step_measure_smooth_gaussian.html">step_measure_smooth_gaussian()</a></code></td>
<td>Gaussian kernel</td>
<td>Preserve peak shapes</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_smooth_wavelet.html">step_measure_smooth_wavelet()</a></code></td>
<td>Wavelet denoising</td>
<td>Complex noise patterns</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/step_measure_filter_fourier.html">step_measure_filter_fourier()</a></code></td>
<td>Frequency filtering</td>
<td>Periodic noise removal</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_despike.html">step_measure_despike()</a></code></td>
<td>Spike removal</td>
<td>Cosmic rays, detector glitches</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="alignment-registration">Alignment &amp; Registration<a class="anchor" aria-label="anchor" href="#alignment-registration"></a>
</h3>
<table class="table">
<colgroup>
<col width="25%">
<col width="33%">
<col width="41%">
</colgroup>
<thead><tr class="header">
<th>Step</th>
<th>Effect</th>
<th>Use when</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code><a href="../reference/step_measure_align_shift.html">step_measure_align_shift()</a></code></td>
<td>Cross-correlation alignment</td>
<td>Simple linear shifts</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_align_reference.html">step_measure_align_reference()</a></code></td>
<td>Align to reference</td>
<td>External calibration standard</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/step_measure_align_dtw.html">step_measure_align_dtw()</a></code></td>
<td>Dynamic time warping</td>
<td>Non-linear distortions</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_align_ptw.html">step_measure_align_ptw()</a></code></td>
<td>Parametric time warping</td>
<td>Polynomial warping functions</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/step_measure_align_cow.html">step_measure_align_cow()</a></code></td>
<td>Correlation optimized warping</td>
<td>Piecewise segment alignment</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="quality-control">Quality Control<a class="anchor" aria-label="anchor" href="#quality-control"></a>
</h3>
<table class="table">
<colgroup>
<col width="25%">
<col width="33%">
<col width="41%">
</colgroup>
<thead><tr class="header">
<th>Step</th>
<th>Effect</th>
<th>Use when</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code><a href="../reference/step_measure_qc_snr.html">step_measure_qc_snr()</a></code></td>
<td>Calculate SNR</td>
<td>Quality filtering</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_qc_saturated.html">step_measure_qc_saturated()</a></code></td>
<td>Detect saturation</td>
<td>Identify clipped data</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/step_measure_qc_outlier.html">step_measure_qc_outlier()</a></code></td>
<td>Detect outliers</td>
<td>Sample screening</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_impute.html">step_measure_impute()</a></code></td>
<td>Fill missing values</td>
<td>Gap interpolation</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="baseline-correction-1">Baseline Correction<a class="anchor" aria-label="anchor" href="#baseline-correction-1"></a>
</h3>
<table class="table">
<colgroup>
<col width="25%">
<col width="33%">
<col width="41%">
</colgroup>
<thead><tr class="header">
<th>Step</th>
<th>Effect</th>
<th>Use when</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code><a href="../reference/step_measure_baseline_als.html">step_measure_baseline_als()</a></code></td>
<td>Asymmetric LS</td>
<td>Smooth baselines, general purpose</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_baseline_poly.html">step_measure_baseline_poly()</a></code></td>
<td>Polynomial fit</td>
<td>Simple, predictable baselines</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/step_measure_baseline_rolling.html">step_measure_baseline_rolling()</a></code></td>
<td>Rolling ball</td>
<td>Wide peaks, chromatography</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_baseline_airpls.html">step_measure_baseline_airpls()</a></code></td>
<td>Adaptive weights</td>
<td>Complex, varying baselines</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/step_measure_baseline_arpls.html">step_measure_baseline_arpls()</a></code></td>
<td>Asymmetric reweighted PLS</td>
<td>Robust to outliers</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_baseline_snip.html">step_measure_baseline_snip()</a></code></td>
<td>Iterative clipping</td>
<td>Sharp peaks, spectroscopy</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/step_measure_baseline_tophat.html">step_measure_baseline_tophat()</a></code></td>
<td>Top-hat filter</td>
<td>Morphological baseline</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_baseline_morph.html">step_measure_baseline_morph()</a></code></td>
<td>Iterative morphological</td>
<td>Gradual baselines</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/step_measure_baseline_minima.html">step_measure_baseline_minima()</a></code></td>
<td>Local minima interpolation</td>
<td>Simple chromatography</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_baseline_auto.html">step_measure_baseline_auto()</a></code></td>
<td>Automatic selection</td>
<td>Unknown baseline type</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/step_measure_detrend.html">step_measure_detrend()</a></code></td>
<td>Polynomial detrend</td>
<td>Linear/quadratic drift</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="peak-operations">Peak Operations<a class="anchor" aria-label="anchor" href="#peak-operations"></a>
</h3>
<table class="table">
<colgroup>
<col width="25%">
<col width="33%">
<col width="41%">
</colgroup>
<thead><tr class="header">
<th>Step</th>
<th>Effect</th>
<th>Use when</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code><a href="../reference/step_measure_peaks_detect.html">step_measure_peaks_detect()</a></code></td>
<td>Find peaks</td>
<td>Chromatography, feature extraction</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_peaks_integrate.html">step_measure_peaks_integrate()</a></code></td>
<td>Calculate areas</td>
<td>Quantitative analysis</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/step_measure_peaks_filter.html">step_measure_peaks_filter()</a></code></td>
<td>Remove small peaks</td>
<td>Focus on major peaks</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_peaks_deconvolve.html">step_measure_peaks_deconvolve()</a></code></td>
<td>Separate overlapping peaks</td>
<td>Resolve co-eluting peaks</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/step_measure_peaks_to_table.html">step_measure_peaks_to_table()</a></code></td>
<td>Wide format output</td>
<td>Modeling with peak features</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="secgpc-analysis">SEC/GPC Analysis<a class="anchor" aria-label="anchor" href="#secgpc-analysis"></a>
</h3>
<table class="table">
<colgroup>
<col width="25%">
<col width="33%">
<col width="41%">
</colgroup>
<thead><tr class="header">
<th>Step</th>
<th>Effect</th>
<th>Use when</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code><a href="../reference/step_measure_mw_averages.html">step_measure_mw_averages()</a></code></td>
<td>Calculate Mn, Mw, Mz, Mp, Đ</td>
<td>Polymer characterization</td>
</tr>
<tr class="even">
<td><code><a href="../reference/step_measure_mw_distribution.html">step_measure_mw_distribution()</a></code></td>
<td>Generate MW distribution curve</td>
<td>Distribution analysis</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/step_measure_mw_fractions.html">step_measure_mw_fractions()</a></code></td>
<td>Calculate MW fractions</td>
<td>Size-based fractionation</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="custom">Custom<a class="anchor" aria-label="anchor" href="#custom"></a>
</h3>
<table class="table">
<colgroup>
<col width="25%">
<col width="33%">
<col width="41%">
</colgroup>
<thead><tr class="header">
<th>Step</th>
<th>Effect</th>
<th>Use when</th>
</tr></thead>
<tbody><tr class="odd">
<td><code>step_measure_map(fn)</code></td>
<td>Custom transformation</td>
<td>Domain-specific needs</td>
</tr></tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="tips-for-choosing-preprocessing">Tips for choosing preprocessing<a class="anchor" aria-label="anchor" href="#tips-for-choosing-preprocessing"></a>
</h2>
<ol style="list-style-type: decimal">
<li>
<strong>Start simple</strong>: Try SNV or first derivative alone
before complex pipelines</li>
<li>
<strong>Visualize</strong>: Always plot preprocessed spectra to
check for artifacts</li>
<li>
<strong>Validate</strong>: Use cross-validation to compare
preprocessing strategies</li>
<li>
<strong>Domain knowledge</strong>: Consider the physics of your
measurement system</li>
<li>
<strong>Tune</strong>: Use <code><a href="https://hardhat.tidymodels.org/reference/tune.html" class="external-link">tune()</a></code> to optimize
Savitzky-Golay parameters</li>
</ol>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ul>
<li>Savitzky, A., and Golay, M. J. E. (1964). Smoothing and
Differentiation of Data by Simplified Least Squares Procedures.
<em>Analytical Chemistry</em>, 36(8), 1627-1639.</li>
<li>Barnes, R. J., Dhanoa, M. S., and Lister, S. J. (1989). Standard
Normal Variate Transformation and De-Trending of Near-Infrared Diffuse
Reflectance Spectra. <em>Applied Spectroscopy</em>, 43(5), 772-777.</li>
<li>Geladi, P., MacDougall, D., and Martens, H. (1985). Linearization
and Scatter-Correction for Near-Infrared Reflectance Spectra of Meat.
<em>Applied Spectroscopy</em>, 39(3), 491-500.</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by James Wade.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
